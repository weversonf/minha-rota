<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#121212">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="apple-mobile-web-app-status-bar-style" content="black-translucent">
    <title>Minha Rota </title>
    
    <link rel="manifest" href='data:application/manifest+json,{"name":"Minha Rota GPS","short_name":"MinhaRota","start_url":"index.html","display":"standalone","background_color":"#121212","theme_color":"#e74c3c","icons":[{"src":"https://cdn-icons-png.flaticon.com/512/1673/1673273.png","sizes":"512x512","type":"image/png","purpose":"any maskable"}]}'>

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

    <style>
        :root { --cor-principal: #e74c3c; --cor-fundo: #121212; --cor-ui: rgba(30, 30, 30, 0.95); --cor-sucesso: #2ecc71; }
        body { margin: 0; padding: 0; background: var(--cor-fundo); font-family: 'Segoe UI', sans-serif; overflow: hidden; color: white; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; display: none; }
        
        #speed-panel { position: fixed; bottom: 100px; left: 15px; z-index: 200; display: none; flex-direction: column; align-items: center; }
        #current-speed { font-size: 42px; font-weight: 900; background: var(--cor-ui); padding: 8px 15px; border-radius: 12px; border: 2px solid #444; min-width: 60px; text-align: center; }
        #speed-limit { font-size: 20px; font-weight: bold; color: #121212; background: white; border: 4px solid #e74c3c; width: 45px; height: 45px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-top: -10px; z-index: 210; }
        
        #nav-header { position: fixed; top: 10px; left: 10px; right: 10px; z-index: 200; display: none; flex-direction: column; gap: 5px; }
        .search-box { background: var(--cor-ui); border-radius: 10px; border: 1px solid #444; overflow: hidden; }
        
        #status-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--cor-ui); padding: 12px; z-index: 150; display: none; justify-content: space-around; border-top: 1px solid #333; }
        .stat-val { display: block; font-size: 20px; font-weight: 800; color: var(--cor-sucesso); }
        .stat-lab { font-size: 10px; color: #888; text-transform: uppercase; }

        .seta-veiculo { width: 0; height: 0; border-left: 10px solid transparent; border-right: 10px solid transparent; border-bottom: 30px solid #3498db; filter: drop-shadow(0 0 5px #3498db); }

        #btn-start { background: var(--cor-principal); color: white; border: none; padding: 15px 35px; border-radius: 30px; font-weight: bold; position: fixed; bottom: 110px; right: 15px; z-index: 150; display: none; cursor: pointer; box-shadow: 0 4px 15px rgba(0,0,0,0.4); }
        
        #login-screen { position: fixed; width: 100%; height: 100%; background: var(--cor-fundo); display: flex; align-items: center; justify-content: center; z-index: 500; flex-direction: column; }
        #install-prompt { display: none; margin-top: 20px; width: 85%; max-width: 320px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div style="text-align: center; width: 85%;">
        <h1>Minha Rota v21</h1>
        <p style="color:#666">Navegador Inteligente FZ25</p>
        <input type="password" id="group-key" placeholder="Senha do Grupo" style="width: 100%; padding: 18px; border-radius: 12px; background: #1e1e1e; color: white; border: 1px solid #333; text-align: center; margin-bottom: 20px;">
        <button onclick="App.autenticar()" style="width: 100%; padding: 18px; border-radius: 12px; background: var(--cor-principal); color: white; border: none; font-weight: bold; cursor: pointer;">ACESSAR GPS</button>
        
        <div id="install-prompt">
            <button id="btnInstall" style="width: 100%; padding: 15px; border-radius: 12px; background: #34495e; color: white; border: none; font-weight: bold; cursor: pointer;">ðŸ“² INSTALAR NO ANDROID</button>
        </div>
    </div>
</div>

<div id="speed-panel">
    <div id="current-speed">0</div>
    <div id="speed-limit">60</div>
</div>

<div id="nav-header">
    <div class="search-box" id="box-origem"></div>
    <div class="search-box" id="box-destino"></div>
</div>

<button id="btn-start" onclick="App.iniciarNavegacao()">INICIAR ROTA</button>

<div id="status-bar">
    <div class="stat-item"><span class="stat-val" id="val-tempo">--</span><span class="stat-lab">Min</span></div>
    <div class="stat-item"><span class="stat-val" id="val-custo">--</span><span class="stat-lab">Gasto</span></div>
    <div class="stat-item"><span class="stat-val" id="val-dist">--</span><span class="stat-lab">KM</span></div>
</div>

<div id="map"></div>

<script>
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
        document.getElementById('install-prompt').style.display = 'block';
    });

    document.getElementById('btnInstall').addEventListener('click', async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            if (outcome === 'accepted') document.getElementById('install-prompt').style.display = 'none';
            deferredPrompt = null;
        }
    });

    if ('serviceWorker' in navigator) {
        window.addEventListener('load', () => {
            navigator.serviceWorker.register('./sw.js').then(reg => console.log('SW ativo'));
        });
    }

    const App = {
        map: null, marker: null, userLoc: [-38.52, -3.73], modoGPS: false,
        origem: null, destino: null, limitVelocidade: 60,

        autenticar() {
            if (document.getElementById('group-key').value === 'FZ25-FOR') {
                document.getElementById('login-screen').style.display = 'none';
                document.getElementById('map').style.display = 'block';
                document.getElementById('nav-header').style.display = 'flex';
                document.getElementById('speed-panel').style.display = 'flex';
                this.initMapa();
            } else {
                alert('Senha incorreta!');
            }
        },

        initMapa() {
            mapboxgl.accessToken = 'pk.eyJ1Ijoid2V2ZXJzb25mIiwiYSI6ImNtbHF5bmh1YTA0djgzZHB4dTJpaG9rbHgifQ.jo3DG631F030AxG_nFKVEQ';
            this.map = new mapboxgl.Map({ 
                container: 'map', 
                style: 'mapbox://styles/mapbox/dark-v11', 
                center: this.userLoc, 
                zoom: 12,
                pitch: 0 
            });

            const el = document.createElement('div'); el.className = 'seta-veiculo';
            this.marker = new mapboxgl.Marker(el).setLngLat(this.userLoc).addTo(this.map);

            const opt = { accessToken: mapboxgl.accessToken, mapboxgl: mapboxgl, countries: 'br', proximity: { longitude: -38.52, latitude: -3.73 } };
            const geoO = new MapboxGeocoder({ ...opt, placeholder: 'Origem: Minha LocalizaÃ§Ã£o' });
            const geoD = new MapboxGeocoder({ ...opt, placeholder: 'Destino: Para onde?' });

            document.getElementById('box-origem').appendChild(geoO.onAdd(this.map));
            document.getElementById('box-destino').appendChild(geoD.onAdd(this.map));

            geoO.on('result', (e) => { this.origem = e.result.center; this.tracar(); });
            geoD.on('result', (e) => { this.destino = e.result.center; this.tracar(); });

            navigator.geolocation.watchPosition(p => {
                const pos = [p.coords.longitude, p.coords.latitude];
                this.userLoc = pos;
                this.marker.setLngLat(pos);
                
                const speed = Math.round((p.coords.speed || 0) * 3.6);
                document.getElementById('current-speed').innerText = speed;
                
                if(this.modoGPS) {
                    this.map.easeTo({ center: pos, bearing: p.coords.heading || 0, duration: 1000 });
                }
            }, null, { enableHighAccuracy: true });

            this.map.on('load', () => {
                this.map.addSource('traffic', { type: 'vector', url: 'mapbox://mapbox.mapbox-traffic-v1' });
                this.map.addLayer({
                    'id': 'traffic-layer', 'type': 'line', 'source': 'traffic', 'source-layer': 'traffic',
                    'paint': { 
                        'line-width': 3, 
                        'line-color': ['match', ['get', 'congestion'], 'low', '#2ecc71', 'moderate', '#f1c40f', 'heavy', '#e67e22', 'severe', '#e74c3c', '#000000'] 
                    }
                });
            });
        },

        async tracar() {
            if (!this.origem || !this.destino) return;
            const res = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${this.origem[0]},${this.origem[1]};${this.destino[0]},${this.destino[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`);
            const data = await res.json();
            if(data.routes && data.routes[0]) {
                const r = data.routes[0];
                if(this.map.getSource('route')) { this.map.removeLayer('route-line'); this.map.removeSource('route'); }
                this.map.addSource('route', { type: 'geojson', data: { type: 'Feature', geometry: r.geometry } });
                this.map.addLayer({ id: 'route-line', type: 'line', source: 'route', paint: { 'line-color': '#3498db', 'line-width': 8 } });
                
                document.getElementById('val-tempo').innerText = Math.round(r.duration/60);
                document.getElementById('val-dist').innerText = (r.distance/1000).toFixed(1);
                document.getElementById('val-custo').innerText = "R$ " + ((r.distance/1000 / 29) * 6.15).toFixed(2);
                document.getElementById('btn-start').style.display = 'block';
                document.getElementById('status-bar').style.display = 'flex';
            }
        },

        iniciarNavegacao() {
            this.modoGPS = true;
            document.getElementById('nav-header').style.display = 'none';
            document.getElementById('btn-start').style.display = 'none';
            this.map.flyTo({ center: this.userLoc, zoom: 18, pitch: 60, speed: 1.2 });
            window.speechSynthesis.speak(new SpeechSynthesisUtterance("NavegaÃ§Ã£o iniciada. Siga a linha azul."));
        }
    };
</script>
</body>
</html>
