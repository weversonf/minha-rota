<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="theme-color" content="#121212">
    <title>Minha Rota v18 - Radar & Velocidade</title>
    
    <link rel="manifest" href="data:application/manifest+json,{"name":"Minha Rota GPS","short_name":"MinhaRota","start_url":".","display":"standalone","background_color":"#121212","theme_color":"#e74c3c"}">

    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />
    <script src="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.min.js"></script>
    <link rel="stylesheet" href="https://api.mapbox.com/mapbox-gl-js/plugins/mapbox-gl-geocoder/v5.0.0/mapbox-gl-geocoder.css" type="text/css">

    <style>
        :root { --cor-principal: #e74c3c; --cor-fundo: #121212; --cor-ui: rgba(30, 30, 30, 0.98); --cor-sucesso: #2ecc71; }
        body { margin: 0; padding: 0; background: var(--cor-fundo); font-family: 'Segoe UI', sans-serif; overflow: hidden; color: white; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; }
        
        /* Painel de Velocidade */
        #speed-panel { position: fixed; bottom: 100px; left: 20px; z-index: 200; display: flex; flex-direction: column; align-items: center; }
        #current-speed { font-size: 48px; font-weight: 900; background: var(--cor-ui); padding: 10px 20px; border-radius: 15px; border: 2px solid #444; min-width: 80px; text-align: center; }
        #speed-limit { font-size: 24px; font-weight: bold; color: #121212; background: white; border: 4px solid #e74c3c; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-top: -15px; z-index: 210; }
        .overspeed { color: #ff0000 !important; border-color: #ff0000 !important; }

        /* Cabe√ßalho e UI */
        #nav-header { position: fixed; top: 10px; left: 10px; right: 10px; z-index: 200; display: flex; flex-direction: column; gap: 8px; }
        .search-box { background: var(--cor-ui); border-radius: 12px; border: 1px solid #444; }
        #status-bar { position: fixed; bottom: 0; left: 0; width: 100%; background: var(--cor-ui); padding: 15px; z-index: 150; display: flex; justify-content: space-around; border-top: 1px solid #333; }
        .stat-val { display: block; font-size: 22px; font-weight: 800; color: var(--cor-sucesso); }
        .stat-lab { font-size: 10px; color: #888; text-transform: uppercase; }

        /* Seta do Ve√≠culo */
        .seta-veiculo { width: 0; height: 0; border-left: 12px solid transparent; border-right: 12px solid transparent; border-bottom: 35px solid #3498db; filter: drop-shadow(0 0 8px #3498db); }
        
        /* Marcador de Radar */
        .marker-radar { font-size: 24px; filter: drop-shadow(0 0 5px rgba(0,0,0,0.5)); }

        #btn-start { background: var(--cor-principal); color: white; border: none; padding: 18px 40px; border-radius: 35px; font-weight: bold; position: fixed; bottom: 100px; right: 20px; z-index: 150; display: none; cursor: pointer; }
    </style>
</head>
<body>

<div id="speed-panel">
    <div id="current-speed">0</div>
    <div id="speed-limit">60</div>
</div>

<div id="nav-header">
    <div class="search-box" id="box-origem"></div>
    <div class="search-box" id="box-destino"></div>
</div>

<button id="btn-start" onclick="App.iniciarNavegacao()">IR AGORA</button>

<div id="status-bar">
    <div class="stat-item"><span class="stat-val" id="val-tempo">--</span><span class="stat-lab">Min</span></div>
    <div class="stat-item"><span class="stat-val" id="val-custo">--</span><span class="stat-lab">Gasto</span></div>
    <div class="stat-item"><span class="stat-val" id="val-dist">--</span><span class="stat-lab">KM</span></div>
</div>

<div id="map"></div>

<script>
    const App = {
        map: null, marker: null, userLoc: [-38.52, -3.73], modoGPS: false,
        limitAtual: 60,

        init() {
            mapboxgl.accessToken = 'pk.eyJ1Ijoid2V2ZXJzb25mIiwiYSI6ImNtbHF5bmh1YTA0djgzZHB4dTJpaG9rbHgifQ.jo3DG631F030AxG_nFKVEQ';
            this.map = new mapboxgl.Map({ container: 'map', style: 'mapbox://styles/mapbox/dark-v11', center: this.userLoc, zoom: 12 });

            const el = document.createElement('div'); el.className = 'seta-veiculo';
            this.marker = new mapboxgl.Marker(el).setLngLat(this.userLoc).addTo(this.map);

            const opt = { accessToken: mapboxgl.accessToken, mapboxgl: mapboxgl, countries: 'br', proximity: { longitude: -38.52, latitude: -3.73 } };
            const geoO = new MapboxGeocoder({ ...opt, placeholder: 'Origem...' });
            const geoD = new MapboxGeocoder({ ...opt, placeholder: 'Destino...' });

            document.getElementById('box-origem').appendChild(geoO.onAdd(this.map));
            document.getElementById('box-destino').appendChild(geoD.onAdd(this.map));

            geoO.on('result', (e) => { this.origem = e.result.center; this.tracar(); });
            geoD.on('result', (e) => { this.destino = e.result.center; this.tracar(); });

            navigator.geolocation.watchPosition(p => {
                const pos = [p.coords.longitude, p.coords.latitude];
                this.userLoc = pos;
                this.marker.setLngLat(pos);
                
                // Atualiza Velocidade (m/s para km/h)
                const speed = Math.round((p.coords.speed || 0) * 3.6);
                const speedEl = document.getElementById('current-speed');
                speedEl.innerText = speed;
                
                if(speed > this.limitAtual) speedEl.classList.add('overspeed');
                else speedEl.classList.remove('overspeed');

                if(this.modoGPS) {
                    this.map.easeTo({ center: pos, bearing: p.coords.heading || 0, duration: 1000 });
                }
            }, null, { enableHighAccuracy: true });

            this.map.on('load', () => this.carregarRecursos());
        },

        carregarRecursos() {
            // Exemplo de Fotossensores em Fortaleza (Pode adicionar mais coordenadas)
            const radares = [
                { nome: 'Radar Av. Washington Soares', coords: [-38.485, -3.765] },
                { nome: 'Radar Av. Bezerra de Menezes', coords: [-38.555, -3.735] }
            ];

            radares.forEach(r => {
                const rel = document.createElement('div'); rel.className = 'marker-radar'; rel.innerHTML = 'üì∏';
                new mapboxgl.Marker(rel).setLngLat(r.coords).setPopup(new mapboxgl.Popup().setHTML(r.nome)).addTo(this.map);
            });
        },

        async tracar() {
            if (!this.origem || !this.destino) return;
            const res = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${this.origem[0]},${this.origem[1]};${this.destino[0]},${this.destino[1]}?geometries=geojson&access_token=${mapboxgl.accessToken}`);
            const data = await res.json();
            if(data.routes[0]) {
                const r = data.routes[0];
                if(this.map.getSource('route')) this.map.removeLayer('route-line').removeSource('route');
                this.map.addSource('route', { type: 'geojson', data: { type: 'Feature', geometry: r.geometry } });
                this.map.addLayer({ id: 'route-line', type: 'line', source: 'route', paint: { 'line-color': '#3498db', 'line-width': 8 } });
                
                document.getElementById('val-tempo').innerText = Math.round(r.duration/60);
                document.getElementById('val-dist').innerText = (r.distance/1000).toFixed(1);
                document.getElementById('val-custo').innerText = "R$ " + ((r.distance/1000 / 29) * 6.15).toFixed(2);
                document.getElementById('btn-start').style.display = 'block';
            }
        },

        iniciarNavegacao() {
            this.modoGPS = true;
            document.getElementById('nav-header').style.display = 'none';
            document.getElementById('btn-start').style.display = 'none';
            this.map.flyTo({ center: this.userLoc, zoom: 18, pitch: 60 });
            window.speechSynthesis.speak(new SpeechSynthesisUtterance("Navega√ß√£o iniciada. Cuidado com os radares."));
        }
    };

    window.onload = () => App.init();
</script>
</body>
</html>
