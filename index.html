<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <link rel="manifest" href="manifest.json">
    <title>Minha Rota v03</title>
    <script src="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.js"></script>
    <link href="https://api.mapbox.com/mapbox-gl-js/v3.0.1/mapbox-gl.css" rel="stylesheet" />
    <style>
        :root { --cor-principal: #e74c3c; --cor-fundo: #121212; }
        body { margin: 0; padding: 0; background: var(--cor-fundo); font-family: 'Segoe UI', Roboto, sans-serif; overflow: hidden; }
        #map { position: absolute; top: 0; bottom: 0; width: 100%; display: none; }
        
        /* Tela de Login */
        #login-screen { 
            position: fixed; width: 100%; height: 100%; background: var(--cor-fundo); 
            display: flex; flex-direction: column; align-items: center; justify-content: center; color: white; z-index: 100;
        }
        .login-card { width: 85%; max-width: 400px; text-align: center; }
        input { 
            padding: 18px; border-radius: 12px; border: 1px solid #333; margin-bottom: 15px; 
            width: 100%; background: #1e1e1e; color: white; text-align: center; font-size: 18px; box-sizing: border-box;
        }
        button { 
            padding: 18px; background: var(--cor-principal); color: white; border: none; 
            border-radius: 12px; font-weight: bold; width: 100%; font-size: 16px; cursor: pointer;
        }

        /* Card de Informações Inferior */
        #info-card {
            position: fixed; bottom: 25px; left: 5%; width: 90%; background: rgba(255,255,255,0.98); 
            padding: 20px; border-radius: 20px; display: none; z-index: 50; box-shadow: 0 10px 30px rgba(0,0,0,0.5);
            animation: slideUp 0.3s ease-out;
        }
        @keyframes slideUp { from { transform: translateY(100%); } to { transform: translateY(0); } }
        
        .valor-gasto { color: #27ae60; font-size: 24px; font-weight: bold; margin-top: 5px; }
        .detalhe-rota { color: #555; font-size: 14px; }
    </style>
</head>
<body>

<div id="login-screen">
    <div class="login-card">
        <h1>Minha Rota v03</h1>
        <p style="color: #888; margin-bottom: 30px;">Segurança e Economia para sua FZ25</p>
        <input type="password" id="group-key" placeholder="Chave do Grupo" autocomplete="off">
        <button onclick="checkKey()">ENTRAR</button>
    </div>
</div>

<div id="map"></div>

<div id="info-card">
    <div style="display: flex; justify-content: space-between;">
        <div>
            <div id="rota-distancia" style="font-weight: bold; color: #333; font-size: 16px;">Traçando rota...</div>
            <div class="detalhe-rota">FZ25 2023 | 29km/L</div>
        </div>
        <button onclick="document.getElementById('info-card').style.display='none'" style="background: none; border: none; color: #999; font-size: 24px; cursor: pointer;">×</button>
    </div>
    <div class="valor-gasto" id="gasto-estimado">R$ 0,00</div>
</div>

<script>
    const CONFIG = {
        token: 'pk.eyJ1Ijoid2V2ZXJzb25mIiwiYSI6ImNtbHF5bmh1YTA0djgzZHB4dTJpaG9rbHgifQ.jo3DG631F030AxG_nFKVEQ',
        chaveAcesso: 'FZ25-FOR',
        veiculo: { consumo: 29 }, // Fazer 250 faz 29km/L
        precoCombustivel: 6.15, 
        centroInicial: [-38.5267, -3.7319] // Fortaleza, Ceará
    };

    const bancoDados = {
        areasRisco: [
            {
                nome: "Centro - Área Crítica",
                coords: [[-38.540, -3.720], [-38.525, -3.720], [-38.525, -3.730], [-38.540, -3.730]]
            }
        ]
    };

    let userLocation = CONFIG.centroInicial;
    let map;

    // --- MANTER LOGADO ---
    window.onload = function() {
        const chaveSalva = localStorage.getItem('minha_rota_key');
        if (chaveSalva === CONFIG.chaveAcesso) {
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('map').style.display = 'block';
            initMap();
        }
    };

    function checkKey() {
        const inputKey = document.getElementById('group-key').value;
        if(inputKey === CONFIG.chaveAcesso) {
            localStorage.setItem('minha_rota_key', inputKey);
            document.getElementById('login-screen').style.display = 'none';
            document.getElementById('map').style.display = 'block';
            initMap();
        } else { alert('Chave incorreta!'); }
    }

    function initMap() {
        mapboxgl.accessToken = CONFIG.token;
        map = new mapboxgl.Map({
            container: 'map',
            style: 'mapbox://styles/mapbox/dark-v11',
            center: CONFIG.centroInicial,
            zoom: 13
        });

        const geolocate = new mapboxgl.GeolocateControl({
            positionOptions: { enableHighAccuracy: true },
            trackUserLocation: true,
            showUserHeading: true
        });
        map.addControl(geolocate);

        geolocate.on('geolocate', (e) => {
            userLocation = [e.coords.longitude, e.coords.latitude];
        });

        map.on('load', () => {
            // Desenhar Áreas de Risco
            bancoDados.areasRisco.forEach((area, i) => {
                map.addSource(`risco-${i}`, {
                    'type': 'geojson',
                    'data': { 'type': 'Feature', 'geometry': { 'type': 'Polygon', 'coordinates': [area.coords] } }
                });
                map.addLayer({
                    'id': `layer-${i}`, 'type': 'fill', 'source': `risco-${i}`,
                    'paint': { 'fill-color': '#ff0000', 'fill-opacity': 0.35 }
                });
            });

            // Preparar a camada da linha azul
            map.addSource('route', { 'type': 'geojson', 'data': { 'type': 'Feature', 'geometry': { 'type': 'LineString', 'coordinates': [] } } });
            map.addLayer({
                'id': 'route-line', 'type': 'line', 'source': 'route',
                'layout': { 'line-join': 'round', 'line-cap': 'round' },
                'paint': { 'line-color': '#3498db', 'line-width': 6, 'line-opacity': 0.8 }
            });
        });

        map.on('click', async (e) => {
            const coords = e.lngLat;
            const start = `${userLocation[0]},${userLocation[1]}`;
            const end = `${coords.lng},${coords.lat}`;

            try {
                const query = await fetch(`https://api.mapbox.com/directions/v5/mapbox/driving/${start};${end}?geometries=geojson&access_token=${mapboxgl.accessToken}`);
                const json = await query.json();
                
                if (json.routes && json.routes[0]) {
                    const data = json.routes[0];
                    map.getSource('route').setData({
                        'type': 'Feature',
                        'geometry': data.geometry
                    });

                    const distKm = (data.distance / 1000).toFixed(1);
                    const custo = (distKm / CONFIG.veiculo.consumo) * CONFIG.precoCombustivel;

                    document.getElementById('info-card').style.display = 'block';
                    document.getElementById('rota-distancia').innerText = `${distKm} km percorridos`;
                    document.getElementById('gasto-estimado').innerText = `R$ ${custo.toFixed(2)}`;
                }
            } catch (err) {
                console.error("Erro ao traçar rota:", err);
            }
        });
    }
</script>
</body>
</html>
